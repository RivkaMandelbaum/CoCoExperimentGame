<html>
    <head>
        <title>Artwork Selection Experiment</title> <!-- to fill in later -->
        <script src="jspsych-6.2.0/jspsych.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"> </script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
        <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </head>

    <body>
        <div id = "jspsych-target" style = "width:100%; height: 95%"> </div>
        <div class = "total-player-money" style = "margin: auto">
            <!-- <div id = "money-img" style = "height:5%"> 
                <img src = "images/money.png"></img>
            </div> -->
            <div id = "money-amount" style = "height: 5%; text-align:center; font-family: Arial, Helvetica, sans-serif; font-size:large"> </div>
        </div>
    </body>

    <script>
    /* ------------------------------------------------------------  */ 
    /* constants and functions that will be used later defined here: */     
    /* ----------------------------------------------------------- */             
        const numImages = 5; // the number of artworks displayed
        const payToCopy = 2; // amount you need to pay someone to copy their choices
        const startAmount = 20; // amount of money you start with
        const rewardForCorrect = 10; // amount you get when you choose the right answer
        const numPlayers = 4; // number of other players

        // for debugging: 
        const numDecisions = 2; // not currently in use - the number of times you choose best artwork
        const s1 = "<div><img src = 'images/img1.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img5.jpg'></img> </div>";
        const s2 = "<div><img src = 'images/img5.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img1.jpg'></img> </div>";
        const s3 = "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img5.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img1.jpg'></img> </div>";

        // Randomly generates an integer between 1 and numImages. 
        /* function generateArtwork() { 
            let randomNum = (Math.random() * numImages) + 1; // random number between 1 and numImages
            return Math.floor(randomNum); // convert to integer
        } */ 

        // Returns what the correct answer was in the previous trial (useful in case abstraction changes)
        function getCorrectArtwork () { 
            return jsPsych.data.getLastTimelineData().select('correct').values[0];
        }
        // Returns the button selected in previous trial (should be integer between 1 and numImages)
        function getPlayerSelection() {  
            let offByOne = jsPsych.data.getLastTimelineData().select('button_pressed').values[0]; 
            
            // button_pressed stores the first button as 0 but choices starts at 1
            return offByOne + 1; 
        }; 

        // Returns whether player is correct. Currently simple but may be helpful if added abstraction needed
        function isPlayerCorrect() { 
            return (getPlayerSelection() === getCorrectArtwork()); 
        }

        /* Separate from getPlayerSelection() and isPlayerCorrect() because I thought separate code would probably work better for integration: */ 

        // Returns the button dummy player i selected in previous trial 
        function getDummySelection(i) { 
            let offByOne = jsPsych.data.getLastTimelineData().select('dummy_choices').values[0][i]; //.values returns an array with one element, the array dummy_choices, so needs to be [0][i]

            return offByOne + 1; 
        }

        // Returns whether dummy player i was correct in previous trial
        function isDummyCorrect(i) { 
            return (getDummySelection(i) === getCorrectArtwork());
        }

        // creates a player with startAmount of money and numCorrect, numCopied, timesCopying all set to 0. numCorrect and numCopied are useful for testing and in case we want to display those later
        function createPlayer() { 
            this.money = startAmount;
            this.numCorrect = 0;
            this.numCopied = 0;
            this.timesCopying = 0;   
        }

        // tests whether the player object is consistent and returns the player's stats as an array
        function testPlayer(p) {
            let stats = [p.money, p.numCorrect, p.numCopied];
            if (p.money != startAmount + p.numCopied*payToCopy + p.numCorrect*rewardForCorrect - p.timesCopying*payToCopy) console.log("Player error!"); 
            return stats;  
        } 

    /* ------------------------------------------------------------ */ 
    /* creating timeline and trials for experiment begins here:     */     
    /* ------------------------------------------------------------ */ 

        /* display initial amount of money */ 
        document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + startAmount.toString();

        /* create timeline for experiment */ 
        let timeline = []; 

        /* define the player */ 
        let player = new createPlayer(); 

        /* define dummy players */
        /* NOTE: assumes 4 other players, made it print error to console if mismatch */

        let dummyPlayers = []; 

        let player0 = new createPlayer(); // starts from 0 to align with array notation
        dummyPlayers.push(player0); // could do this at once but will be easier to remove players this way if needed 

        let player1 = new createPlayer();
        dummyPlayers.push(player1);

        let player2 = new createPlayer();
        dummyPlayers.push(player2);

        let player3 = new createPlayer();
        dummyPlayers.push(player3);

        // for debugging:
        if (numPlayers != 4) console.log("WARNING! Did you change the number of players?")

        /* define welcome message as a trial */
        let welcome = {
            type: "html-keyboard-response",
            stimulus: `Welcome to the experiment. <br> </br> You will begin with $${startAmount}, as will other players. <br> </br> Press any key to begin.`
        }; 
        timeline.push(welcome); 

        let art_decision_procedure = { 
            timeline: [
                // multiArtDisplay
                {
                    type: "html-button-response",
                    stimulus: jsPsych.timelineVariable('images'),
                    prompt: "Please select what you think is the <strong> highest-value </strong> artwork.",
                    choices: [1, 2, 3, 4, 5], 
                    data: {
                        correct: jsPsych.timelineVariable('correct'),
                        dummy_choices: jsPsych.timelineVariable('dummy_choices')
                    }, 
                    on_finish: function(data) { 
                        // check player correctness and update money/display
                        if(isPlayerCorrect()) {
                            player.money += rewardForCorrect;
                            player.numCorrect++;
                            document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                        }
                        console.log("self " + testPlayer(player)); 

                        // run other player's choices
                        for (i = 0; i < numPlayers; i++) { 
                            if(isDummyCorrect(i)) {
                                dummyPlayers[i].money += rewardForCorrect;
                                dummyPlayers[i].numCorrect ++;
                            }
                            console.log(`player ${i} ${testPlayer(dummyPlayers[i])}`); 
                        }

                    }
                }, 
                // displayResults
                {
                    type: "html-button-response",
                    stimulus: function () { 
                        // displays the player's response and its correctness
                        let response = "Your choice was button number " + getPlayerSelection() + ". \n"; 
                        if (isPlayerCorrect())
                            return response + `Your answer is correct. You earned $${rewardForCorrect}.`; 
                        else 
                            return response + "Your answer is incorrect. The correct value was: " + getCorrectArtwork() + "."; 
                        }, 
                    choices: ["Continue"], 
                },
                // chooseToCopy
                {
                    type: "html-button-response",
                    stimulus: function() { 
                        // returns a string detailing other players' results and asking which to copy
                        s = "Here are the other player's results. <br> </br>"; 
                        for(i = 0; i < numPlayers; i++) {
                            /* if (isDummyCorrect(i)) result = "<strong> correctly </strong>"; 
                            else result = "<strong> incorrectly </strong>";  

                            s = s.concat(`Player ${i} ${result} chose artwork ${getDummySelection(i)}. <br> </br>`); */ 
                            if(jsPsych.timelineVariable('dummy_choices', true)[i] === jsPsych.timelineVariable('correct', true)) s = s.concat("1"); 
                            else s = s.concat("0"); 
                        }

                        s = s.concat(`You may either choose the highest-value artwork on your own or pay another player $${payToCopy} to copy their choice. <br> </br> <br> </br>`);

                        return s; 
                    },
                    prompt: "Which player would you like to copy?", 
                    choices: ["None, I would like to make my own choice.", "Player 1", "Player 2", "Player 3", "Player 4"],
                    on_finish: function(data) {
                        // if the player chooses to copy:
                        if (data.button_pressed != 0) {
                            // adjust and display the player's money and status: 
                            player.money -= payToCopy;
                            document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                            player.timesCopying++; 

                            // and adjust the money of other players
                            for(i = 0; i < numPlayers; i++) {
                                if(data.button_pressed === i) {
                                    dummyPlayers[i].money += payToCopy;
                                    dummyPlayers[i].numCopied++;
                                    console.log(`player ${i} ${testPlayer(dummyPlayers[i])}`);
                                }
                            }
                        }
                    }
                }
            ],
            timeline_variables: [
                {correct: 1, images: s1, dummy_choices: [0, 1, 2, 3]},
                {correct: 2, images: s2, dummy_choices: [0, 1, 2, 3]},
                {correct: 3, images: s3, dummy_choices: [0, 1, 2, 3]}
            ],
            // repetitions: numDecisions  
            /* 
            dummy_correctness: function() { 
                            d_correct = []; 
                            for(i = 0; i < numPlayers; i++) { 
                                d_correct.push(isDummyCorrect(i));
                            }
                            return d_correct;
                        }, 
                        dummy_selection: function() { 
                            d_selected = []; 
                            for(i = 0; i < numPlayers; i++) { 
                                d_selected.push(getDummySelection(i));
                            }
                            return d_selected; 
                        }
                    }, 
                    */  
        }
        timeline.push(art_decision_procedure);

        /* End of experiment page as trial */ 
        let goodbye = { 
            type: "html-keyboard-response", 
            stimulus: "Thanks for participating. The experiment is over. You can close the browser window.",
            choices: jsPsych.NO_KEYS, 
            trial_duration: 2000 // Remove this when not debugging (need this line for displayData())
        };
        timeline.push(goodbye);  

        /* start the experiment */ 
        jsPsych.init({
            timeline: timeline, 
            display_element: 'jspsych-target',
            // For debugging: 
            on_finish: function () {
                console.log("done"); 
                jsPsych.data.displayData();
            },
            show_progress_bar: true 
        }); 
        
    </script>
</html>