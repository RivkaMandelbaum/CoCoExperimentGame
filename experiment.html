<html>
    <head>
        <title>Artwork Selection Experiment</title> 
        <script src="jspsych-6.2.0/jspsych.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"> </script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-multi-image-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
       <!-- <script src = "testimports.js" type = "text/javascript"></script> -->
        <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </head>

    <body>
        <div id = "jspsych-target" style = "width:100%; height: 95%"> </div>
        <div class = "total-player-money" style = "margin: auto">
            <!-- <div id = "money-img" style = "height:5%"> 
                <img src = "images/money.png"></img>
            </div> -->
            <div id = "money-amount" style = "height: 5%; text-align:center; font-family: Arial, Helvetica, sans-serif; font-size:large"> </div>
        </div>
    </body>

    <script>
    /* ----------------------------------------------------------*/ 
    /* constants that will be used later defined here:           */     
    /* ----------------------------------------------------------*/             
        const numImages = 5; // the number of artworks displayed
        const payToCopy = 2; // amount you need to pay someone to copy their choices
        const startAmount = 20; // amount of money you start with
        const rewardForCorrect = 10; // amount you get when you choose the right answer
        const numPlayers = 4; // number of other players

        const numDecisions = 2; // to skip last "choice" screen, rough solution
        const offlineMode = true; 

        /* placeholders */  
        const img1 = "images/img1.jpg";
        const img2 = 'images/img2.jpg';
        const img3 = 'images/img3.jpg';
        const img4 = 'images/img4.jpg';
        const img5 = 'images/img5.jpg';
    
    /* ----------------------------------------------------------*/ 
    /* functions that will be used later defined here:           */     
    /* ----------------------------------------------------------*/
        /* ---- Player creation: ---- */ 

        // creates a player with startAmount of money and numCorrect, numCopied, timesCopying all set to 0. numCorrect and numCopied are useful for testing and in case we want to display those later
        function createPlayer() { 
            this.money = startAmount;
            this.numCorrect = 0;
            this.numCopied = 0;
            this.timesCopying = 0;   
        }

        // tests whether the player object is consistent and returns the player's stats as an array
        function testPlayer(p) {
            if(!'money' in p || !'numCorrect' in p || !'numCopied' in p || !'timesCopying' in p) console.warn("Error! Parameter does not have correct fields.");

            let stats = [p.money, p.numCorrect, p.numCopied];
            if (p.money != startAmount + p.numCopied*payToCopy + p.numCorrect*rewardForCorrect - p.timesCopying*payToCopy) console.warn("Player error!"); 
            return stats;  
        }     

        /* ---- Getting previous choices and correctness: ---- */ 

        // Returns what the correct answer was in the trial with given index
        // Answers are equivalent to indices in the 'choices' array
        function getCorrectArtwork (index) { 
            return jsPsych.data.get().filter({'trial_index':index}).select('correct').values[0];
        }
        // Returns the button selected in trial with given index 
        // Buttons are based on indices in the 'choices array' (should be integer between 0 and numImages-1)
        function getPlayerSelection(index) {  
            let trial_data = jsPsych.data.get().filter({'trial_index': index});
            return trial_data.select('button_pressed').values[0];
        }; 

        // Returns whether player was correct in trial with given index.
        function isPlayerCorrect(index) { 
            return jsPsych.data.get().filter({'trial_index': index}).select('clicked_correct').values[0];
        }

        /* ---- Functions for dummy correctness are separated because they're based on timeline variables rather than on previous trial. ---- */ 

        // Returns the button dummy player i selected in previous trial 
        // i should use array index of player, not player name
        // buttons based on 'choices' array
        function getDummySelection(i) { 
            return jsPsych.timelineVariable('dummy_choices', true)[i];
        }

        // Returns whether dummy player i was correct in previous trial
        // i should use array index of player, not player name
        function isDummyCorrect(i) { 
            return getDummySelection(i) === jsPsych.timelineVariable('correct_choice', true);
        }
    
    /* ------------------------------------------------------------ */ 
    /* trial definion for conditional trials:                       */     
    /* ------------------------------------------------------------ */ 
    // display art and allow selection
    let artDisplaySelection = {
            type: "multi-image-button-response",
            stimulus: jsPsych.timelineVariable('img_array'),
            prompt: "Please select what you think is the <strong> highest-value </strong> artwork.",
            choices: [1, 2, 3, 4, 5], 
            correct_choice: jsPsych.timelineVariable('correct_choice'),
            data: {
                correct: jsPsych.timelineVariable('correct_choice'),
                dummy_choices: jsPsych.timelineVariable('dummy_choices')
            }, 
            on_finish: function(data) { 
                let trial_index = jsPsych.progress().current_trial_global;
                // check player correctness and update money/display
                if(isPlayerCorrect(trial_index)) {
                    player.money += rewardForCorrect;
                    player.numCorrect++;
                    document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                }
                console.log("self " + testPlayer(player)); 
                
                // wait for other player's responses
                jsPsych.pauseExperiment(); 

                // in offline mode, use dummy_choices timeline variable and don't check for a response 
                if(offlineMode) {
                    console.log("offline mode");
                    jsPsych.resumeExperiment();
                }

                else {
                    // PLACEHOLDER FOR DEALING WITH SENDING PLAYER RESPONSE
                    // PLACEHOLDER FOR DEALING WITH RECEIVING RESPONSES 
                    placeholderForResponse = [1, 2, 3, 4];

                    // change dummy_choices timeline variable to reflect the actual response given
                    for (i = 0; i < numPlayers; i++) {
                        jsPsych.data.get().filter({'trial_index': trial_index}).values()[0].dummy_choices[i] = placeholderForResponse[i];
                    }

                    jsPsych.resumeExperiment(); 
                }

                // run other player's choices
                // isDummyCorrect uses timeline variables so the above adjustment should work
                for (i = 0; i < numPlayers; i++) { 
                    if(isDummyCorrect(i)) {
                        dummyPlayers[i].money += rewardForCorrect;
                        dummyPlayers[i].numCorrect ++;
                    }
                    console.log(`player ${i+1} ${testPlayer(dummyPlayers[i])}`); 
                }
                
            }
        };

        // display art but do not allow selection (copy instead)
        let artDisplayCopy = { 
            type: "multi-image-button-response", 
            stimulus: jsPsych.timelineVariable('img_array'), 
            prompt: "Continue to see what choice was made.", 
            choices: ["Continue"],
            data: { 
                correct: jsPsych.timelineVariable('correct_choice'),
                dummy_choices: jsPsych.timelineVariable('dummy_choices')
            },
            on_finish: function(data) { 
                // wait for other player's responses
                jsPsych.pauseExperiment(); 
                if(offlineMode) {
                    console.log("offline mode");
                    jsPsych.pluginAPI.setTimeout(function() {
                        // check correctness of player being copied, update money
                        if(isDummyCorrect(iPlayerCopying-1)) {
                            player.money += rewardForCorrect;
                            player.numCorrect++;
                            document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                        }
                        console.log("self " + testPlayer(player)); 

                        // run other player's choices
                        for (i = 0; i < numPlayers; i++) { 
                            if(isDummyCorrect(i)) {
                                dummyPlayers[i].money += rewardForCorrect;
                                dummyPlayers[i].numCorrect ++;
                            }
                            console.log(`player ${i+1} ${testPlayer(dummyPlayers[i])}`); 
                        }
                        jsPsych.resumeExperiment();
                    }, 1);
                }
                    
                else { 
                    // PLACEHOLDER FOR EVENT HANDLER
                    jsPsych.resumeExperiment();
                }
            }
        }
    /* ------------------------------------------------------------ */ 
    /* begin experiment setup:                                      */     
    /* ------------------------------------------------------------ */ 

        /* display initial amount of money */ 
        document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + startAmount.toString();

        /* create timeline for experiment */ 
        let timeline = []; 

        /* define the player */ 
        let player = new createPlayer(); 

        /* define dummy players */
        /* NOTE: assumes 4 other players, made it print error to console if mismatch */

        let dummyPlayers = []; 

        let player0 = new createPlayer(); // starts from 0 to align with array notation
        dummyPlayers.push(player0); // push one by one for debugging  

        let player1 = new createPlayer();
        dummyPlayers.push(player1);

        let player2 = new createPlayer();
        dummyPlayers.push(player2);

        let player3 = new createPlayer();
        dummyPlayers.push(player3);

        // for debugging:
        if (numPlayers != 4) console.warn("WARNING! Did you change the number of players?")


        let bIsCopying = false; // whether the player is copying in this round
        let iPlayerCopying = 0; // which player they are copying
        let numExecutions = 0; // number of rounds thru timeline 


        /* ------------------------------------------------------------ */ 
        /* define trials on timeline                                    */     
        /* ------------------------------------------------------------ */ 

        /* define welcome message as a trial */
        let welcome = {
            type: "html-keyboard-response",
            stimulus: `Welcome to the experiment. <br> </br> You will begin with $${startAmount}, as will other players. <br> </br> Press any key to begin.`
        }; 
        timeline.push(welcome); 


        /* define art_decision_procedure as three trials: art display and selection, displaying player results, and choice to copy */ 
        let art_decision_procedure = { 
            timeline: [
                // if not copying: display art and allow selection; update money of all players
                {
                    timeline: [artDisplaySelection], 
                    conditional_function: function() { 
                        // return true when the player will select 
                        return !bIsCopying;  
                    }, 
                },
                // if copying: display art and disallow selection; update money of all players 
                {
                    timeline: [artDisplayCopy], 
                    conditional_function: function() { 
                        return bIsCopying; // do NOT recalculate this value - it will use the wrong button press
                    }  
                },
                // display player results and correctness (including if copying)
                {
                    type: "html-button-response",
                    stimulus: function () { 
                        let response = "";
                        let trial_index = jsPsych.progress().current_trial_global - 1;
                        if(!bIsCopying) {
                            let response = "Your choice was button number " + (getPlayerSelection(trial_index)+1) + ". \n"; 

                            if (isPlayerCorrect(trial_index)) {
                                return response + `Your answer is correct. You earned $${rewardForCorrect}.`; 
                            }
                            else {
                                return response + "Your answer is incorrect. The correct value was: " + (getCorrectArtwork(trial_index)+1) + "."; 
                            }
                        }
                        else { 
                            response = `You chose to copy player ${iPlayerCopying}. Player ${iPlayerCopying} chose artwork ${getDummySelection(iPlayerCopying-1) + 1}. <br> </br>`;

                            if(isDummyCorrect(iPlayerCopying-1)) {
                                return response + `Player ${iPlayerCopying} was <strong> correct</strong>. You earned $${rewardForCorrect}.`;
                            }
                            else {
                                return response + `Player ${iPlayerCopying} was <strong> incorrect</strong>. The correct value was ${getCorrectArtwork(trial_index) + 1}.`
                            }
                        }
                    }, 
                    choices: ["Continue"], 
                },
                // display other player results and choose to copy; update money, bIsCopying iPlayerCopying if copying
                {
                    // uses timeline to allow conditional skip on last play
                    timeline: [ {
                        type: "html-button-response",
                        stimulus: function() { 
                            // builds a string detailing player's responses
                            s = "Here are the other player's results. <br> </br>"; 
                            for(i = 0; i < numPlayers; i++) {
                            if(isDummyCorrect(i)) { 
                                d_correct = "<strong> correctly </strong>"; 
                                }
                            else {
                                d_correct = "<strong> incorrectly </strong>";
                            }

                            s = s.concat(`Player ${i+1} ${d_correct} chose artwork ${getDummySelection(i) + 1}. Player ${i+1} now has $${dummyPlayers[i].money}. <br> </br>`);
                            }

                            // adds explanation of choice
                            s = s.concat(`You may either choose the highest-value artwork on your own or pay another player $${payToCopy} to copy their choice. <br> </br> <br> </br>`);

                            return s; 
                        },
                        prompt: "Which player would you like to copy?", 
                        choices: ["None, I would like to make my own choice.", "Player 1", "Player 2", "Player 3", "Player 4"],
                        on_finish: function(data) {
                            // update number of executions
                            numExecutions+= 1; 

                            // send data and wait for other players
                            jsPsych.pauseExperiment(); 
                            
                            if(offlineMode){ 
                                let buttonPressed = data.button_pressed;
                                let playerCopyingIndex = buttonPressed-1;  
                                
                                // if the player chooses to copy:
                                if (buttonPressed != 0 && player.money >= payToCopy) {
                                    // update bIsCopying and iPlayerCopying
                                    bIsCopying = true; 
                                    iPlayerCopying = buttonPressed;

                                    // adjust and display the player's money and status: 
                                    player.money -= payToCopy;
                                    document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                                    player.timesCopying++; 

                                    // and adjust the money of the player being copied
                                    dummyPlayers[playerCopyingIndex].money += payToCopy;
                                    dummyPlayers[playerCopyingIndex].numCopied++;
                                    console.log(`player ${buttonPressed} ${testPlayer(dummyPlayers[playerCopyingIndex])}`);
                                }
                                // if tried to copy but doesn't have enough money, warn player
                                else if (data.button_pressed != 0 && player.money < payToCopy) { 
                                    alert("You do not have enouch money to copy."); 
                                    data.button_pressed = 0; 
                                }
                                // if not copying, update bIsCopying to match
                                else bIsCopying = false; 

                                jsPsych.resumeExperiment(); 
                            }
                            else { 
                                // PLACEHOLDER FOR EVENT HANDLER
                                jsPsych.resumeExperiment(); 
                            }
                        }
                    }], 
                    // skips last execution (before end screen)
                    conditional_function: function() { 
                        return (numExecutions < numDecisions);
                    } 
                }
            ],
            timeline_variables: [
                {correct_choice: 0, img_array: [img1, img2, img3, img4, img5], dummy_choices: [0, 1, 2, 3]},
                {correct_choice: 1, img_array: [img5, img4, img3, img2, img1], dummy_choices: [0, 1, 2, 3]},
                {correct_choice: 2, img_array: [img1, img2, img3, img4, img5], dummy_choices: [0, 1, 2, 3]}
            ],
            // repetitions: numDecisions  

        }
        timeline.push(art_decision_procedure);

        /* End of experiment page as trial */ 
        let goodbye = { 
            type: "html-keyboard-response", 
            stimulus: "Thanks for participating. The experiment is over. You can close the browser window.",
            choices: jsPsych.NO_KEYS, 
            trial_duration: 2000 // Remove this when not debugging (need this line for displayData())
        };
        timeline.push(goodbye);  

        /* start the experiment */ 
        jsPsych.init({
            timeline: timeline, 
            display_element: 'jspsych-target',
            // For debugging: 
            on_finish: function () {
                console.log("done"); 
                jsPsych.data.displayData();
            },
            show_progress_bar: true 
        }); 
        
    </script>
</html>