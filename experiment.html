<html>
    <head>
        <title>Artwork Selection Experiment</title> <!-- to fill in later -->
        <script src="jspsych-6.2.0/jspsych.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"> </script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-image-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
        <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
    </head>

    <body>
        <div id = "jspsych-target" style = "width:100%; height: 95%"> </div>
        <div class = "total-player-money" style = "margin: auto">
            <!-- <div id = "money-img" style = "height:5%"> 
                <img src = "images/money.png"></img>
            </div> -->
            <div id = "money-amount" style = "height: 5%; text-align:center; font-family: Arial, Helvetica, sans-serif; font-size:large"> </div>
        </div>
    </body>

    <script>
    /* ------------------------------------------------------------  */ 
    /* constants and functions that will be used later defined here: */     
    /* ----------------------------------------------------------- */             
        const numImages = 5; // the number of artworks displayed
        const payToCopy = 2; // amount you need to pay someone to copy their choices
        const startAmount = 20; // amount of money you start with
        const rewardForCorrect = 10; // amount you get when you choose the right answer

        document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + startAmount.toString();


        // for debugging: 
        const numDecisions = 2; // the number of times you choose best artwork
        const s1 = "<div><img src = 'images/img1.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img5.jpg'></img> </div>";
        const s2 = "<div><img src = 'images/img5.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img1.jpg'></img> </div>";
        const s3 = "<div><img src = 'images/img3.jpg'></img> </div>" + 
                    "<div><img src = 'images/img4.jpg'></img> </div>" + 
                    "<div><img src = 'images/img5.jpg'></img> </div>" + 
                    "<div><img src = 'images/img2.jpg'></img> </div>" + 
                    "<div><img src = 'images/img1.jpg'></img> </div>";

        // Randomly generates an integer between 1 and numImages to be the correct artwork. 
        function generateArtwork() { 
            let randomNum = (Math.random() * numImages) + 1; // random number between 1 and numImages
            return Math.floor(randomNum); // convert to integer
        }

        // Returns the button selected in previous trial (should be integer between 1 and 5)
        function getArtWorkSelected() { 
            /* jsPsych.data returns a DataCollection object. Using .select('button_pressed') gives you a DataColumn object. Using .values gives you an array of all values for button_pressed. In this case, there is only one button_pressed -- use [0] to grab that. */
            let offByOne = jsPsych.data.getLastTrialData().select('button_pressed').values[0]; 
            // button_pressed stores the first button as 0; I started labeling at 1. This does conversion.
            return offByOne + 1; 
        }; 

        // Returns what the correct answer was in the previous trial (useful because it's randomized)
        function getCorrectArtwork () { 
            return jsPsych.data.getLastTrialData().select('correct').values[0];
        }

        // Returns whether the answer in the previous trial was correct (should be boolean)
        function isAnswerCorrect(isDummy) { 
            let correctAnswer = jsPsych.data.getLastTrialData().select('correct').values[0];

            if (!isDummy) {
                return (getArtWorkSelected() === correctAnswer); 
            }
            else {
                return (generateArtwork() === correctAnswer)
            }

        }

    /* ------------------------------------------------------------ */ 
    /* creating timeline and trials for experiment begins here:     */     
    /* ------------------------------------------------------------ */ 

        /* create timeline for experiment */ 
        let timeline = []; 

        /* define the player */ 
        let player = {
            money: startAmount, 
            numCorrect: 0 // useful if we want to display how much of their money is correct vs. copied later
        };

        /* define dummy players */ 
        let dummyPlayers = {
            player1: { 
                money: startAmount,
                numCorrect: 0
            }, 
            player2: { 
                money: startAmount,
                numCorrect: 0
            },
            player3: { 
                money: startAmount,
                numCorrect: 0
            },
            player4: { 
                money: startAmount,
                numCorrect: 0
            },
        }

        /* define welcome message as a trial */
        let welcome = {
            type: "html-keyboard-response",
            stimulus: `Welcome to the experiment. <br> </br> You will begin with $${startAmount}, as will other players. <br> </br> Press any key to begin.`
        }; 
        timeline.push(welcome); 

        let art_decision_procedure = { 
            timeline: [
                // multiArtDisplay
                {
                    type: "html-button-response",
                    stimulus: jsPsych.timelineVariable('images'),
                    prompt: "Please select what you think is the <strong> highest-value </strong> artwork.",
                    choices: [1, 2, 3, 4, 5], 
                    data: {correct: jsPsych.timelineVariable('correct')}, 
                    on_finish: function(data) { 
                        // check player correctness and update money/display
                        if(isAnswerCorrect(false)) {
                            player.money += rewardForCorrect;
                            player.numCorrect++;
                            document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString(); 
                        }

                        // run other player's choices
                        if(isAnswerCorrect(true)) { 
                            dummyPlayers.player1.money += rewardForCorrect;
                            dummyPlayers.player1.numCorrect ++; 
                        }
                        console.log(`player 1 money: ${dummyPlayers.player1.money}`);

                        if(isAnswerCorrect(true)) { 
                            dummyPlayers.player2.money += rewardForCorrect;
                            dummyPlayers.player2.numCorrect ++; 
                        }                            
                        console.log(`player 2 money: ${dummyPlayers.player2.money}`);

                        if(isAnswerCorrect(true)) { 
                            dummyPlayers.player3.money += rewardForCorrect;
                            dummyPlayers.player3.numCorrect ++; 
                        }
                        console.log(`player 3 money: ${dummyPlayers.player3.money}`);

                        if(isAnswerCorrect(true)) { 
                            dummyPlayers.player4.money += rewardForCorrect;
                            dummyPlayers.player4.numCorrect ++; 
                        }
                        console.log(`player 4 money: ${dummyPlayers.player4.money}`);

                    }
                }, 
                // displayResults
                {
                    type: "html-button-response",
                    stimulus: function () { 
                        let response = "Your choice was button number " + getArtWorkSelected() + ". \n"; 
                        if (isAnswerCorrect(false)) 
                            return response + `Your answer is correct. You earned $${rewardForCorrect}.`; 
                        else 
                            return response + "Your answer is incorrect. The correct value was: " + getCorrectArtwork() + "."; 
                        }, 
                    choices: ["Continue"]
                },
                // chooseToCopy
                {
                    type: "html-button-response",
                    stimulus: "Here are the other players' results. PLACEHOLDER! <br> </br> In the next round, " + 
                    `you may either choose the highest-value artwork on your own or pay another player $${payToCopy} to copy their choice. <br> </br> <br> </br>`,
                    prompt: "Which player would you like to copy?", 
                    choices: ["None, I would like to make my own choice.", "Player 1", "Player 2", "Player 3", "Player 4"],
                    on_finish: function(data) {
                        // if the player chooses to copy:
                        if (data.button_pressed != 0) {
                            // adjust and display the player's money: 
                            player.money -= payToCopy;
                            document.getElementById("money-amount").innerHTML = "Your total amount of money is: " + player.money.toString();
                            // and adjust the money of other players
                            if (data.button_pressed === 1) { 
                                dummyPlayers.player1.money += payToCopy;
                                console.log(`player 1 money: ${dummyPlayers.player1.money}`);
                            }
                            else if (data.button_pressed === 2) { 
                                dummyPlayers.player2.money += payToCopy;
                                console.log(`player 2 money: ${dummyPlayers.player2.money}`);
                            }
                            else if (data.button_pressed === 3) { 
                                dummyPlayers.player3.money += payToCopy;
                                console.log(`player 3 money: ${dummyPlayers.player3.money}`);
                            }
                            else {
                                dummyPlayers.player4.money += payToCopy; 
                                console.log(`player 4 money: ${dummyPlayers.player4.money}`);
                            }
                        }
                    }
                }
            ],
            timeline_variables: [
                // for debugging: 
                {correct: 1, images: s1},
                // {correct: generateArtwork(), images: s1},
                {correct: generateArtwork(), images: s2},
                {correct: generateArtwork(), images: s3}
            ],
            // repetitions: numDecisions   
        }
        timeline.push(art_decision_procedure);

        /* End of experiment page as trial */ 
        let goodbye = { 
            type: "html-keyboard-response", 
            stimulus: "Thanks for participating. The experiment is over. You can close the browser window.",
            choices: jsPsych.NO_KEYS, 
            trial_duration: 2000 // Remove this when not debugging (need this line for displayData())
        };
        timeline.push(goodbye);  

        /* start the experiment */ 
        jsPsych.init({
            timeline: timeline, 
            display_element: 'jspsych-target',
            // For debugging: 
            on_finish: function () {
                console.log("done"); 
                jsPsych.data.displayData();
            },
            show_progress_bar: true 
        }); 
        
    </script>
</html>